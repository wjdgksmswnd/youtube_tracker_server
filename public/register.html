<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>O.D.O beta - 회원가입</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
  <style>
    :root {
      --primary-color: #4285f4;
      --secondary-color: #3367d6;
      --light-bg: #ffffff;
      --light-text: #202124;
      --dark-bg: #202124;
      --dark-text: #e8eaed;
      --dark-card: #303134;
      --dark-border: #5f6368;
    }
    
    body {
      font-family: 'Roboto', Arial, sans-serif;
      transition: background-color 0.3s, color 0.3s;
      background-color: var(--light-bg);
      color: var(--light-text);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    body.dark-mode {
      background-color: var(--dark-bg);
      color: var(--dark-text);
    }
    
    .dark-mode .card {
      background-color: var(--dark-card);
      border-color: var(--dark-border);
    }
    
    .dark-mode .form-control {
      background-color: var(--dark-card);
      border-color: var(--dark-border);
      color: var(--dark-text);
    }
    
    .toggle-switch {
      position: relative;
      display: inline-block;
      width: 50px;
      height: 24px;
    }
    
    .toggle-switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }
    
    .toggle-slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #ccc;
      transition: .4s;
      border-radius: 24px;
    }
    
    .toggle-slider:before {
      position: absolute;
      content: "";
      height: 18px;
      width: 18px;
      left: 3px;
      bottom: 3px;
      background-color: white;
      transition: .4s;
      border-radius: 50%;
    }
    
    input:checked + .toggle-slider {
      background-color: var(--primary-color);
    }
    
    input:checked + .toggle-slider:before {
      transform: translateX(26px);
    }
    
    .register-container {
      max-width: 500px;
      width: 100%;
      padding: 15px;
    }
    
    .password-strength {
      height: 5px;
      transition: width 0.3s;
    }
    
    .password-feedback {
      display: none;
      font-size: 0.85rem;
    }
  </style>
</head>
<body>
  <div class="register-container">
    <div class="card shadow-sm">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h3 class="mb-0">회원가입</h3>
        <label class="toggle-switch" title="다크 모드">
          <input type="checkbox" id="dark-mode-toggle">
          <span class="toggle-slider"></span>
        </label>
      </div>
      <div class="card-body">
        <form id="register-form">
          <div class="mb-3">
            <label for="username" class="form-label">사용자 이름</label>
            <input type="text" class="form-control" id="username" name="username" required>
            <div id="username-feedback" class="form-text text-danger"></div>
          </div>
          <div class="mb-3">
            <label for="email" class="form-label">이메일</label>
            <input type="email" class="form-control" id="email" name="email" required>
            <div id="email-feedback" class="form-text text-danger"></div>
          </div>
          <div class="mb-3">
            <label for="password" class="form-label">비밀번호</label>
            <input type="password" class="form-control" id="password" name="password" required>
            <div class="mt-2">
              <div class="progress">
                <div id="password-strength" class="password-strength progress-bar" role="progressbar"></div>
              </div>
            </div>
            <div id="password-feedback" class="password-feedback text-muted mt-1">
              <ul class="mb-0 ps-3">
                <li id="length-check">8자 이상</li>
                <li id="uppercase-check">대문자 포함</li>
                <li id="lowercase-check">소문자 포함</li>
                <li id="number-check">숫자 포함</li>
                <li id="special-check">특수 문자 포함</li>
              </ul>
            </div>
          </div>
          <div class="mb-3">
            <label for="confirm-password" class="form-label">비밀번호 확인</label>
            <input type="password" class="form-control" id="confirm-password" name="confirm-password" required>
            <div id="confirm-password-feedback" class="form-text text-danger"></div>
          </div>
          <div class="mb-3 form-check">
            <input type="checkbox" class="form-check-input" id="terms-check" required>
            <label class="form-check-label" for="terms-check">이용 약관 및 개인정보 처리방침에 동의합니다.</label>
          </div>
          <div id="register-error" class="alert alert-danger" style="display: none;"></div>
          <div class="d-grid gap-2">
            <button type="submit" class="btn btn-primary">가입하기</button>
            <a href="index.html" class="btn btn-outline-secondary">이미 계정이 있으신가요? 로그인</a>
          </div>
        </form>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // API URL 설정
    const API_URL = 'http://localhost:8080';
    
    // DOM 요소 참조
    const registerForm = document.getElementById('register-form');
    const usernameInput = document.getElementById('username');
    const emailInput = document.getElementById('email');
    const passwordInput = document.getElementById('password');
    const confirmPasswordInput = document.getElementById('confirm-password');
    const usernameFeedback = document.getElementById('username-feedback');
    const emailFeedback = document.getElementById('email-feedback');
    const passwordStrength = document.getElementById('password-strength');
    const passwordFeedback = document.getElementById('password-feedback');
    const confirmPasswordFeedback = document.getElementById('confirm-password-feedback');
    const registerError = document.getElementById('register-error');
    const darkModeToggle = document.getElementById('dark-mode-toggle');
    
    // 비밀번호 확인 관련 요소
    const lengthCheck = document.getElementById('length-check');
    const uppercaseCheck = document.getElementById('uppercase-check');
    const lowercaseCheck = document.getElementById('lowercase-check');
    const numberCheck = document.getElementById('number-check');
    const specialCheck = document.getElementById('special-check');
    
    // 다크 모드 설정 불러오기
    loadDarkModeSetting();
    
    // 폼 제출 이벤트 리스너
    registerForm.addEventListener('submit', handleRegister);
    
    // 다크 모드 토글 이벤트 리스너
    darkModeToggle.addEventListener('change', toggleDarkMode);
    
    // 비밀번호 입력 시 강도 체크
    passwordInput.addEventListener('input', checkPasswordStrength);
    passwordInput.addEventListener('focus', function() {
      passwordFeedback.style.display = 'block';
    });
    
    passwordInput.addEventListener('blur', function() {
      passwordFeedback.style.display = 'none';
    });
    
    // 비밀번호 확인 일치 여부 체크
    confirmPasswordInput.addEventListener('input', checkPasswordMatch);
    
    // 사용자 이름 중복 체크
    usernameInput.addEventListener('blur', checkUsernameAvailability);
    
    // 이메일 중복 체크
    emailInput.addEventListener('blur', checkEmailAvailability);
    
    // 다크 모드 설정 불러오기
    function loadDarkModeSetting() {
      const isDarkMode = localStorage.getItem('darkMode') === 'true';
      darkModeToggle.checked = isDarkMode;
      
      if (isDarkMode) {
        document.body.classList.add('dark-mode');
      }
    }
    
    // 다크 모드 토글 함수
    function toggleDarkMode() {
      if (darkModeToggle.checked) {
        document.body.classList.add('dark-mode');
        localStorage.setItem('darkMode', 'true');
      } else {
        document.body.classList.remove('dark-mode');
        localStorage.setItem('darkMode', 'false');
      }
    }
    
    // 회원가입 처리 함수
    function handleRegister(e) {
      e.preventDefault();
      
      // 입력값 유효성 검사
      if (!validateForm()) {
        return;
      }
      
      // 회원가입 요청
      fetch(`${API_URL}/api/register`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          username: usernameInput.value,
          email: emailInput.value,
          password: passwordInput.value
        })
      })
      .then(response => {
        if (!response.ok) {
          return response.json().then(data => {
            throw new Error(data.error || '회원가입에 실패했습니다.');
          });
        }
        return response.json();
      })
      .then(data => {
        if (data.message === '사용자 등록 성공') {
          // 회원가입 성공
          alert('회원가입이 완료되었습니다. 로그인 페이지로 이동합니다.');
          window.location.href = 'index.html';
        }
      })
      .catch(error => {
        console.error('Registration error:', error);
        registerError.textContent = error.message || '서버 연결에 실패했습니다.';
        registerError.style.display = 'block';
      });
    }
    
    // 폼 유효성 검사
    function validateForm() {
      let isValid = true;
      
      // 사용자 이름 검사
      if (usernameInput.value.length < 3) {
        usernameFeedback.textContent = '사용자 이름은 3자 이상이어야 합니다.';
        isValid = false;
      } else {
        usernameFeedback.textContent = '';
      }
      
      // 이메일 검사
      const emailPattern = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      if (!emailPattern.test(emailInput.value)) {
        emailFeedback.textContent = '유효한 이메일 주소를 입력하세요.';
        isValid = false;
      } else {
        emailFeedback.textContent = '';
      }
      
      // 비밀번호 검사
      if (getPasswordStrength(passwordInput.value) < 3) {
        passwordStrength.classList.remove('bg-warning', 'bg-success');
        passwordStrength.classList.add('bg-danger');
        isValid = false;
      }
      
      // 비밀번호 확인 검사
      if (passwordInput.value !== confirmPasswordInput.value) {
        confirmPasswordFeedback.textContent = '비밀번호가 일치하지 않습니다.';
        isValid = false;
      } else {
        confirmPasswordFeedback.textContent = '';
      }
      
      return isValid;
    }
    
    // 비밀번호 강도 체크
    function checkUsernameAvailability() {
  const username = usernameInput.value;
  
  if (username.length < 3) {
    usernameFeedback.textContent = '사용자 이름은 3자 이상이어야 합니다.';
    return;
  }
      
      // 강도에 따른 프로그레스 바 업데이트
      passwordStrength.style.width = `${strength * 25}%`;
      
      if (strength === 0) {
        passwordStrength.className = 'password-strength progress-bar';
      } else if (strength < 2) {
        passwordStrength.className = 'password-strength progress-bar bg-danger';
      } else if (strength < 4) {
        passwordStrength.className = 'password-strength progress-bar bg-warning';
      } else {
        passwordStrength.className = 'password-strength progress-bar bg-success';
      }
      
      // 각 요구사항 체크
      lengthCheck.className = password.length >= 8 ? 'text-success' : '';
      uppercaseCheck.className = /[A-Z]/.test(password) ? 'text-success' : '';
      lowercaseCheck.className = /[a-z]/.test(password) ? 'text-success' : '';
      numberCheck.className = /[0-9]/.test(password) ? 'text-success' : '';
      specialCheck.className = /[^A-Za-z0-9]/.test(password) ? 'text-success' : '';
    }
    
    // 비밀번호 강도 계산 (0-4)
    function getPasswordStrength(password) {
      let strength = 0;
      
      if (password.length >= 8) strength++;
      if (/[A-Z]/.test(password)) strength++;
      if (/[a-z]/.test(password)) strength++;
      if (/[0-9]/.test(password)) strength++;
      if (/[^A-Za-z0-9]/.test(password)) strength++;
      
      return Math.min(4, strength);
    }
    
    // 비밀번호 일치 여부 확인
    function checkPasswordMatch() {
      if (passwordInput.value !== confirmPasswordInput.value) {
        confirmPasswordFeedback.textContent = '비밀번호가 일치하지 않습니다.';
      } else {
        confirmPasswordFeedback.textContent = '';
      }
    }
    
    // 사용자 이름 중복 체크
    function checkUsernameAvailability() {
      const username = usernameInput.value;
      
      if (username.length < 3) {
        usernameFeedback.textContent = '사용자 이름은 3자 이상이어야 합니다.';
        return;
      }
      
      fetch(`http://localhost:8080/api/check-username?username=${encodeURIComponent(username)}`)
    .then(response => {
      if (!response.ok) {
        throw new Error('서버 응답 오류: ' + response.status);
      }
      return response.json();
    })
    .then(data => {
      if (data.available === false) {
        usernameFeedback.textContent = '이미 사용 중인 사용자 이름입니다.';
      } else {
        usernameFeedback.textContent = '';
      }
    })
    .catch(error => {
      console.error('Username check error:', error);
      usernameFeedback.textContent = '서버 연결 오류, 나중에 다시 시도하세요';
    });
}
    
    // 이메일 중복 체크
    function checkEmailAvailability() {
      const email = emailInput.value;
      
      const emailPattern = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      if (!emailPattern.test(email)) {
        emailFeedback.textContent = '유효한 이메일 주소를 입력하세요.';
        return;
      }
      
      fetch(`${API_URL}/api/check-email?email=${encodeURIComponent(email)}`)
        .then(response => {
          if (!response.ok) {
            throw new Error('서버 응답 오류');
          }
          return response.json();
        })
        .then(data => {
          if (data.available === false) {
            emailFeedback.textContent = '이미 사용 중인 이메일 주소입니다.';
          } else {
            emailFeedback.textContent = '';
          }
        })
        .catch(error => {
          console.error('Email check error:', error);
          // 중복 체크 실패 시 사용자에게 알리지 않고 계속 진행
        });
    }
  </script>
</body>
</html>